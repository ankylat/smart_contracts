# Anky Smart Contracts - Project #1 - The Writing Dementor

## Overview

This codebase contains the contracts and deployment scripts for the first game that will be developed under the framework of Anky: "The Writing Dementor" (we need a better name for it).

Here is a set of images with an overview explanation of what this system is about:

![System Overview](https://github.com/ankylat/smart_contracts/blob/main/public/images/1.png?raw=true)

The workflow is:

1. The user signs up for an account. As soon as that happens, she will be airdropped an ERC720 NFT on the newly created account (the system is set up using privy)
   - This will happen through the "Anky Airdrop" smart contract, which will be called through a backend that is running this software: https://www.github.com/ankylat/backend
   - We pay for the airdrop fees.
   - Inside the airdrop functionality there is also a call to the ERC6551 registry, to create a Token Bound Account (TBA) for this NFT. This TBA will serve as the place where the user will keep the "notebooks".
2. What are the notebooks? Inside this first game, users will be able to create notebook templates, which then will be minted by other users for them to write in there.
   - Each notebook has the following properties:
     a) address creator: The address of the owner of the anky. This is the address that was generated by privy when the user logged in.
     b) string metadataURI: A pointer to arweave, on which the information related to the notebook template will be stored.
     c) uint256 numPages: The number of pages (prompts) that this specific notebook has. Each notebook will have a set of prompts that will be created by the person that came up with the template. When someone mints the notebook, they will have access to these and they will be able to write on them through anky.
     d) uint256 price: The price for minting the notebook. This is defined by the creator of the template, and when someone mints an instance of the notebook:
     d.1) 10% will remain on anky as royalties.
     d.2) 20% will go to the person that created the notebook template.
     d.3) 70% will go back to the account that is minting the notebook. This will give that person credits inside the platform, which then will be user to write on the notebook (each time they submit their writing we need to pay 2 fees: bundlr and a blockchain interaction for updating the entry of that particular instance of a notebook on the blockchain). Each minted notebook is an ERC721 NFT, and the data associated with it will be updated when the user writes and submits the writing (which will be stored on arweave using bundlr).
     e) uint256 supply: The amount of templates that is available for people to mint. If you come up with a template, there will be a limited supply of it. This will create a market for the minted notebooks, which will be interesting on the long term.

The main contracts of interest are:

- **AnkyAirdrop.sol**: This contract enables airdropping NFTs to users and provides them with token-bound accounts (TBA).
- **AnkyTemplates.sol**: A contract related to the capacity that users of the platform will have for creating notebook templates, so that other users can later mint them and write on them.
- **AnkyNotebooks.sol**: A contract related to Anky's notebook functionality. It transforms each template into an ERC721 Non-Fungible Token, that the user that owns it can write on following the prompts that were established by the creator of the template.
- **ERC6551Registry.sol** & **ERC6551Account.sol**: These contracts are part of the ERC-6551 specification, allowing the creation of TBAs for NFTs.

## Contract Descriptions

### AnkyAirdrop.sol

#### Properties:

- `registry`: A reference to the ERC6551Registry that keeps track of TBAs.
- `ownerToTBA`: A mapping that relates an NFT owner to its associated TBA.

#### Functions:

- `airdropNft(address to)`: Airdrops an NFT to a specified address.
- `createTBAforUsersAnky(address userWallet)`: Creates a TBA for a user's Anky NFT.
- `getTBA(uint256 tokenId)`: Retrieves the TBA address from the Registry using the tokenId.
- `getUsersAnkyAddress(address userWallet)`: Retrieves the TBA address of the NFT that a specified user owns.
- `setTokenURI(uint256 tokenId, string memory newUri)`: Sets or updates the token URI.
- `getTokenURI(uint256 tokenId)`: Retrieves the token URI.

### AnkyTemplates.sol

AnkyTemplates is used to define and manage the structure of the notebooks (the templates).

The AnkyTemplates smart contract serves as a repository for notebook templates created by users owning an Anky. Every template contains metadata like the creator's address, associated metadata URI, the number of pages it has, its price, and the supply. This contract acts as an ERC1155 token, which means each template has an ID and can have multiple supplies. The instancesOfTemplate mapping provides an efficient way to fetch all notebook instances minted from a particular template. This contract ensures that only valid Anky owners can create templates and integrates with the AnkyAirdrop contract to verify Anky ownership.

### AnkyNotebooks.sol

AnkyNotebooks is for the actual instances of notebooks minted from templates. It communicates with AnkyTemplates to get information about the structure of a template.

The AnkyNotebooks smart contract is responsible for minting and managing individual notebook instances based on the templates from the AnkyTemplates contract. As an ERC721 token, every notebook instance is unique, having an associated template ID and a status to determine if any writing has occurred. The contract also provides functionalities for users to write content on notebook pages and to check the content of any written page. For every minted notebook, an event is emitted, and the associated costs are shared with the creator. The contract collaborates with the AnkyAirdrop contract to ensure that only valid Anky owners can mint notebooks and write on them.

### ERC6551Registry.sol & ERC6551Account.sol

Contracts that implement the ERC-6551 specification, providing the ability to create TBAs for NFTs.

## Deployment Scripts

### deploy_anky_airdrop_contracts.js

This script handles the deployment of:

- **ERC6551Registry**
- **ERC6551Account**
- **AnkyAirdrop** (with the ERC6551Account's address as the `implementationAddress`)

### deploy_notebooks.js

Deploys the **AnkyNotebooks** contract.

## Development

The development environment uses Hardhat. What is being developed is a system that consists of 3 core pieces:

- Front end -> Built on top of nextjs. https://www.github.com/ankylat/anky.lat
- Back end -> Built on nodejs, for sending the requests to the smart contracts using the owner of the system as the proxy. https://www.github.com/ankylat/backend
- Smart Contracts -> This repo. It is the back bones of the system on the blockchain.

The goal is to develop all of this having in mind the modularity aspect of it. To reproduce this system on your local environment:

- Clone the 3 repos.
- Deploy the smart contracts running:

```bash
npx hardhat run --network localhost scripts/deploy_anky_airdrop_contracts.js
npx hardhat run --network localhost scripts/deploy_notebooks.js

```

- Run the nodejs server on port 3000.
- Run the nextjs app on port 3001.

Help us build what is happening here. There are many challenges, and the system is complex.

WE NEED YOUR HELP!
